#!/usr/bin/env bash
#
# Copyright (C) - 2017 Philippe Proulx <pproulx@efficios.com>
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License, version 2 only, as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 51
# Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

curdir="$(dirname $0)"
testdir="$curdir/.."
babeltrace_bin="$curdir/../../cli/babeltrace"

source $testdir/utils/tap/tap.sh

test_bt_convert_run_args() {
	local what="$1"
	local convert_args="$2"
	local expected_run_args="$3"

	# execute convert command
	local run_args="$("$babeltrace_bin" convert --run-args $convert_args)"

	# check result
	if [ "$test_head_comment" = 1 ]; then
		comment "convert args: $convert_args"
	fi

	if [ "$run_args" == "$expected_run_args" ]; then
		pass "ARGS: $what"
	else
		fail "ARGS: $what"
		diag "EXPECTED: $expected_run_args"
		diag "GOT:      $run_args"
	fi
}

test_bt_convert_fails() {
	local what="$1"
	local convert_args="$2"

	# execute convert command
	"$babeltrace_bin" convert --run-args $convert_args &> /dev/null

	local status=$?

	# check result
	if [ "$test_head_comment" = 1 ]; then
		comment "convert args: $convert_args"
	fi

	if [ $status == 0 ]; then
		fail "SUCCEEDS (should fail): $what"
		diag "ARGS: $convert_args"
	else
		pass "FAILS: $what"
	fi
}

comment() {
	echo "### $1 ###"
}

plan_tests 82

test_bt_convert_run_args 'path leftover' '/path/to/trace' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + named user source with --params' '/path/to/trace --source ZZ:another.source --params salut=yes' '--source ZZ:another.source --params salut=yes --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ZZ:muxer --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + named user source with --name --params' '/path/to/trace --source another.source --name HELLO --params salut=yes' '--source another.source --name HELLO --params salut=yes --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect HELLO:muxer --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + user source with --path --params' '/path/to/trace --source another.source --path some-path --params salut=yes' "--source another.source --key path --value some-path --params salut=yes --name another.source --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect 'another\\.source:muxer' --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty"
test_bt_convert_run_args 'user source with --url + -o dummy' '--source MY:my.source --url the-url -o dummy' '--source MY:my.source --key url --value the-url --sink utils.dummy --name dummy --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect MY:muxer --connect muxer:debug-info --connect debug-info:dummy'
test_bt_convert_run_args 'path leftover + --omit-home-plugin-path' '/path/to/trace --omit-home-plugin-path' '--omit-home-plugin-path --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --omit-system-plugin-path' '/path/to/trace --omit-system-plugin-path' '--omit-system-plugin-path --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --plugin-path' '--plugin-path=PATH1:PATH2 /path/to/trace' '--plugin-path PATH1:PATH2 --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'unnamed user source' '--source salut.com' "--source salut.com --name salut.com --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect 'salut\.com:muxer' --connect muxer:debug-info --connect debug-info:pretty"
test_bt_convert_run_args 'path leftover + user source named `ctf-fs`' '--source ctf-fs:salut.com /path/to/trace' "--source ctf-fs:salut.com --source ctf.fs --name ctf-fs-0 --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect ctf-fs-0:muxer --connect muxer:debug-info --connect debug-info:pretty"
test_bt_convert_run_args 'path leftover + user sink named `pretty`' '--sink pretty:my.sink /path/to/trace' '--sink pretty:my.sink --source ctf.fs --name ctf-fs --key path --value /path/to/trace --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --clock-seconds + user sink named `pretty`' '--clock-seconds --sink pretty:my.sink /path/to/trace' '--sink pretty:my.sink --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty-0 --params clock-seconds=yes --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty --connect debug-info:pretty-0'
test_bt_convert_run_args 'path leftover + user filter named `muxer`' '--filter muxer:salut.com /path/to/trace' '--filter muxer:salut.com --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer-0 --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer-0 --connect muxer-0:debug-info --connect debug-info:muxer --connect muxer:pretty'
test_bt_convert_run_args 'path leftover + --begin + user filter named `trimmer`' '/path/to/trace --filter trimmer:salut.com --begin=abc' '--filter trimmer:salut.com --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter utils.trimmer --name trimmer-0 --key begin --value abc --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:trimmer-0 --connect trimmer-0:debug-info --connect debug-info:trimmer --connect trimmer:pretty'
test_bt_convert_run_args 'path leftover + --plugin-path' '/path/to/trace --plugin-path a:b:c' '--plugin-path a:b:c --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --omit-home-plugin-path --omit-system-plugin-path' '/path/to/trace --omit-home-plugin-path --omit-system-plugin-path' '--omit-home-plugin-path --omit-system-plugin-path --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --begin' '/path/to/trace --begin=123' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter utils.trimmer --name trimmer --key begin --value 123 --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:trimmer --connect trimmer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --begin --end' '/path/to/trace --end=456 --begin 123' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter utils.trimmer --name trimmer --key end --value 456 --key begin --value 123 --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:trimmer --connect trimmer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --timerange' '/path/to/trace --timerange=[abc,xyz]' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter utils.trimmer --name trimmer --key begin --value abc --key end --value xyz --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:trimmer --connect trimmer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --clock-cycles' '/path/to/trace --clock-cycles' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params clock-cycles=yes --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --clock-date' '/path/to/trace --clock-date' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params clock-date=yes --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --force-correlate' '/path/to/trace --clock-force-correlate' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --params force-correlate=yes --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --clock-gmt' '/path/to/trace --clock-gmt' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params clock-gmt=yes --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --clock-offset' '/path/to/trace --clock-offset=15487' '--source ctf.fs --name ctf-fs --key clock-offset-cycles --value 15487 --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --clock-offset-ns' '/path/to/trace --clock-offset-ns=326159487' '--source ctf.fs --name ctf-fs --key clock-offset-ns --value 326159487 --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --clock-seconds' '/path/to/trace --clock-seconds' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params clock-seconds=yes --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --color' '/path/to/trace --color=never' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --key color --value never --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --no-debug-info' '/path/to/trace --no-debug-info' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --connect ctf-fs:muxer --connect muxer:pretty'
test_bt_convert_run_args 'path leftover + --debug-info-dir' '/path/to/trace --debug-info-dir=/salut' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --key dir --value /salut --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --debug-info-target-prefix' '/path/to/trace --debug-info-target-prefix=/salut' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --key target-prefix --value /salut --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --debug-info-full-path' '/path/to/trace --debug-info-full-path' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --params full-path=yes --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --fields=trace:domain,loglevel' '--fields=trace:domain,loglevel /path/to/trace' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params field-trace:domain=yes,field-loglevel=yes,field-default=hide --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --fields=all' '--fields=all /path/to/trace' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params field-default=show --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --names=context,header' '--names=context,header /path/to/trace' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params name-context=yes,name-header=yes,name-default=hide --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --names=all' '--names=all /path/to/trace' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params name-default=show --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --no-delta' '/path/to/trace --no-delta' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params no-delta=yes --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --output' '/path/to/trace --output /salut' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --key path --value /salut --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + --stream-intersection' '/path/to/trace --stream-intersection' '--source ctf.fs --name ctf-fs --params stream-intersection=yes --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + -i ctf' '/path/to/trace -i ctf' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'URL leftover + -i lttng-live' 'net://some-host/host/target/session -i lttng-live' '--source ctf.lttng-live --name lttng-live --key url --value net://some-host/host/target/session --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect lttng-live:muxer --connect muxer:debug-info --connect debug-info:pretty'
test_bt_convert_run_args 'path leftover + user sink + -o text' '/path/to/trace --sink=abc.def -o text' "--sink abc.def --name abc.def --source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect 'debug-info:abc\.def' --connect debug-info:pretty"
test_bt_convert_run_args 'path leftover + -o dummy' '/path/to/trace -o dummy' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink utils.dummy --name dummy --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:dummy'
test_bt_convert_run_args 'path leftover + -o dummy + --clock-seconds' '/path/to/trace -o dummy --clock-seconds' '--source ctf.fs --name ctf-fs --key path --value /path/to/trace --sink text.pretty --name pretty --params clock-seconds=yes --sink utils.dummy --name dummy --filter utils.muxer --name muxer --filter lttng-utils.debug-info --name debug-info --connect ctf-fs:muxer --connect muxer:debug-info --connect debug-info:pretty --connect debug-info:dummy'

test_bt_convert_fails 'bad --source format (plugin only)' '--source salut'
test_bt_convert_fails 'bad --source format (name and plugin only)' '--source name:salut'
test_bt_convert_fails 'bad --source format (name only)' '--source name:'
test_bt_convert_fails 'bad --source format (extra dot found)' '--source name:plugin.comp.cls'
test_bt_convert_fails 'bad --filter format (plugin only)' '--filter salut'
test_bt_convert_fails 'bad --filter format (name and plugin only)' '--filter name:salut'
test_bt_convert_fails 'bad --filter format (name only)' '--filter name:'
test_bt_convert_fails 'bad --filter format (extra dot found)' '--filter name:plugin.comp.cls'
test_bt_convert_fails 'bad --sink format (plugin only)' '--sink salut'
test_bt_convert_fails 'bad --sink format (name and plugin only)' '--sink name:salut'
test_bt_convert_fails 'bad --sink format (name only)' '--sink name:'
test_bt_convert_fails 'bad --sink format (extra dot found)' '--sink name:plugin.comp.cls'
test_bt_convert_fails 'duplicate component name' '--sink hello:a.b --source hello:c.d'
test_bt_convert_fails 'unknown option' '--sink hello:a.b --salut'
test_bt_convert_fails '--params without current component' '--params lol=23'
test_bt_convert_fails '--path without current component' '--path /path/to/trace'
test_bt_convert_fails '--url without current component' '--url net://some-host/host/target/session'
test_bt_convert_fails '--nane without current component' '--name chapeau'
test_bt_convert_fails 'duplicate --begin' '--begin abc --clock-seconds --begin cde'
test_bt_convert_fails 'duplicate --end' '--begin abc --end xyz --clock-seconds --end cde'
test_bt_convert_fails '--begin and --timerange' '--begin abc --clock-seconds --timerange abc,def'
test_bt_convert_fails '--end and --timerange' '--end abc --clock-seconds --timerange abc,def'
test_bt_convert_fails 'bad --timerange format (1)' '--timerange abc'
test_bt_convert_fails 'bad --timerange format (2)' '--timerange abc,'
test_bt_convert_fails 'bad --timerange format (3)' '--timerange ,cde'
test_bt_convert_fails 'bad --fields format' '--fields salut'
test_bt_convert_fails 'bad --names format' '--names salut'
test_bt_convert_fails 'unknown -i' '-i lol'
test_bt_convert_fails 'duplicate -i' '-i lttng-live --clock-seconds --input-format=ctf'
test_bt_convert_fails 'unknown -o' '-o lol'
test_bt_convert_fails 'duplicate -o' '-o dummy --clock-seconds --output-format=text'
test_bt_convert_fails '--run-args and --run-args-0' '/path/to/trace --run-args --run-args-0'
test_bt_convert_fails 'duplicate -v' '/path/to/trace -vv'
test_bt_convert_fails 'two leftover arguments' '/path/to/trace /other/path'
test_bt_convert_fails '-o ctf-metadata without path' '-o ctf-metadata'
test_bt_convert_fails '-i lttng-live and implicit ctf.fs source' '-i lttng-live net://some-host/host/target/session --clock-offset=23'
test_bt_convert_fails 'implicit ctf.fs source without path' '--clock-offset=23'
test_bt_convert_fails 'implicit ctf.lttng-live source without URL' '-i lttng-live'
test_bt_convert_fails 'no source' '-o text'
